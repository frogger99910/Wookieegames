<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Adventure Platformer</title>
    <style>
        canvas {
            display: block;
            margin: 0 auto;
            background: linear-gradient(skyblue, lightgreen);
        }
    </style>
</head>
<body>
<canvas id="gameCanvas" width="800" height="600"></canvas>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    const gravity = 0.8;
    const player = {
        x: 50,
        y: 500,
        width: 50,
        height: 60,
        color: 'blue',
        speed: 5,
        dx: 0,
        dy: 0,
        swinging: false,
        swingAngle: 0,
        whip: { length: 150, active: false, x: 0, y: 0, color: 'black' }
    };

    const levels = [
        {
            platforms: [
                { x: 0, y: 550, width: 800, height: 50, color: 'green' },
                { x: 300, y: 450, width: 200, height: 20, color: 'brown' },
                { x: 600, y: 350, width: 150, height: 20, color: 'brown' },
            ],
            swingPoints: [{ x: 400, y: 300, radius: 15, color: 'yellow' }],
            enemies: [
                { x: 500, y: 500, width: 40, height: 40, color: 'red', speed: 2, direction: 1, alive: true }
            ]
        }
    ];
    let currentLevel = 0;
    let platforms = levels[currentLevel].platforms;
    let swingPoints = levels[currentLevel].swingPoints;
    let enemies = levels[currentLevel].enemies;

    document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowRight') player.dx = player.speed;
        if (e.key === 'ArrowLeft') player.dx = -player.speed;
        if ((e.key === 'ArrowUp' || e.key === ' ') && !player.swinging && player.dy === 0) {
            player.dy = -15;
        }
        if (e.key === 'z') player.whip.active = true;
    });

    document.addEventListener('keyup', (e) => {
        if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') player.dx = 0;
        if (e.key === 'z') player.whip.active = false;
        if (player.swinging) {
            player.swinging = false;
            player.dy = -10; // Launch off the swing
        }
    });

    function update() {
        if (player.swinging) {
            const point = swingPoints.find(p =>
                Math.hypot(player.whip.x - p.x, player.whip.y - p.y) <= p.radius
            );
            if (point) {
                player.swingAngle += 0.05;
                player.x = point.x + Math.cos(player.swingAngle) * player.whip.length;
                player.y = point.y + Math.sin(player.swingAngle) * player.whip.length;
            } else {
                player.swinging = false;
            }
        } else {
            player.x += player.dx;
            player.y += player.dy;
            player.dy += gravity;

            platforms.forEach(platform => {
                if (
                    player.x < platform.x + platform.width &&
                    player.x + player.width > platform.x &&
                    player.y + player.height > platform.y &&
                    player.y + player.height < platform.y + platform.height
                ) {
                    player.y = platform.y - player.height;
                    player.dy = 0;
                }
            });

            if (player.y + player.height > canvas.height) {
                player.y = canvas.height - player.height;
                player.dy = 0;
            }
            if (player.x < 0) player.x = 0;
            if (player.x + player.width > canvas.width) player.x = canvas.width - player.width;

            // Whip interaction with swing points and enemies
            if (player.whip.active) {
                // Target the nearest swing point
                const nearestPoint = swingPoints.find(p =>
                    Math.hypot(player.x + player.width / 2 - p.x, player.y + player.height / 2 - p.y) <= player.whip.length
                );

                // Target the nearest enemy
                const nearestEnemy = enemies.find(enemy =>
                    enemy.alive && Math.hypot(player.x + player.width / 2 - (enemy.x + enemy.width / 2),
                                              player.y + player.height / 2 - (enemy.y + enemy.height / 2)) <= player.whip.length
                );

                if (nearestEnemy) {
                    player.whip.x = nearestEnemy.x + nearestEnemy.width / 2;
                    player.whip.y = nearestEnemy.y + nearestEnemy.height / 2;

                    if (
                        Math.hypot(player.whip.x - (nearestEnemy.x + nearestEnemy.width / 2),
                                   player.whip.y - (nearestEnemy.y + nearestEnemy.height / 2)) < 5
                    ) {
                        nearestEnemy.alive = false;
                    }
                } else if (nearestPoint) {
                    player.whip.x = nearestPoint.x;
                    player.whip.y = nearestPoint.y;
                    if (Math.hypot(player.whip.x - nearestPoint.x, player.whip.y - nearestPoint.y) <= nearestPoint.radius) {
                        player.swinging = true;
                        player.swingAngle = Math.atan2(player.y - nearestPoint.y, player.x - nearestPoint.x);
                    }
                } else {
                    player.whip.x = player.x + player.width / 2;
                    player.whip.y = player.y + player.height / 2;
                }
            }
        }

        enemies.forEach(enemy => {
            if (enemy.alive) {
                enemy.x += enemy.speed * enemy.direction;
                if (enemy.x <= 0 || enemy.x + enemy.width >= canvas.width) {
                    enemy.direction *= -1;
                }
            }
        });

        draw();
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        ctx.fillStyle = player.color;
        ctx.fillRect(player.x, player.y, player.width, player.height);

        if (player.whip.active) {
            ctx.strokeStyle = player.whip.color;
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(player.x + player.width / 2, player.y + player.height / 2);
            ctx.lineTo(player.whip.x, player.whip.y);
            ctx.stroke();
        }

        platforms.forEach(platform => {
            ctx.fillStyle = platform.color;
            ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
        });

        swingPoints.forEach(point => {
            ctx.fillStyle = point.color;
            ctx.beginPath();
            ctx.arc(point.x, point.y, point.radius, 0, Math.PI * 2);
            ctx.fill();
        });

        enemies.forEach(enemy => {
            if (enemy.alive) {
                ctx.fillStyle = enemy.color;
                ctx.fillRect(enemy.x, enemy.y, enemy.width, enemy.height);
            }
        });

        requestAnimationFrame(update);
    }

    update();
</script>
</body>
</html>
